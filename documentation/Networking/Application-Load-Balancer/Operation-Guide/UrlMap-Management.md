# 转发规则组管理

[原理介绍](urlmap-management#user-content-1)

[添加转发规则组(转发、重定向)](urlmap-management#user-content-2)

[管理转发规则组](urlmap-management#user-content-3)

## 原理介绍
<div id="user-content-1"></div>

应用负载均衡通过配置转发规则组可实现基于访问请求的域名和URL路径将访问请求转发给不同的后端服务处理或重定向到指定URL。一个转发规则组中可配置多条转发规则。转发规则中定义匹配请求的域名、URL路径和转发动作。

同一个转发规则组中，系统默认已经根据匹配优先级为您配置完的多条转发规则进行了排序。按照匹配优先级由高到低的顺序，访问请求依次匹配各转发规则，匹配某规则成功后，即将请求转发给该规则绑定的后端服务处理或重定向到至指定URL。

#### 规则域名

域名支持输入IPv4地址和域名。域名支持精确匹配和通配符匹配两种。

- 精确匹配：输入格式如www.jdcloud.com
- 通配符匹配：输入格式必须以“\*”开头或结尾，如\*.XXX或XXX.\*

当一个客户端请求同时匹配多条转发规则的域名时，规则匹配优先级为精确匹配>以\*开头的最长通配符匹配>以\*结尾的最长通配符匹配。

#### 规则URL路径

URL路径支持精确匹配和前缀匹配两种。

- 精确匹配：输入格式如/path/abc
- 前缀匹配：输入格式必须以“\*”结尾，如/path1\*

当一个客户端请求同时匹配域名相同且URL路径不同的多条规则时，匹配优先级为精确匹配>最长前缀匹配。

#### 转发动作(转发、重定向)

匹配转发规则后执行的动作，取值包括转发至和重定向至两种。

- 转发至：将匹配规则的访问请求转发给指定后端服务器处理。配置转发至动作的规则还客配置如下扩展动作：
   - 写入Header（请求）：经过负载均衡转发给后端服务器的请求支持写入指定HTTP Header。将覆盖客户端请求Header中已有变量。
   - 删除Header（请求）：经过负载均衡转发给后端服务器的请求支持删除指定HTTP Header。
   - 镜像至（请求）：负载均衡将请求转发给后端服务器的同时，支持镜像一份到其他后端服务器组。镜像功能可以实现生产流量仿真，将生产流量镜像到测试环境的后端服务器，同时负载均衡自动丢弃镜像后端服务器返回的响应数据，保证镜像后端服务器的测试业务不会影响到生产业务。
   - 重写（请求）：支持重写访问请求的域名、路径和查询字段。重写路径字段支持以*结尾的后缀匹配。
   - 写入Header（响应）：负载均衡将后端服务器返回的请求转发给客户端时，支持写入指定Header。将覆盖响应Header中已有变量。例如，某些安全要求比较高的场景，需要写入安全相关HTTP header。
   - 删除Header（响应）：负载均衡将后端服务器返回的请求转发给客户端时，支持删除指定Header。
- 重定向至：将匹配规则的访问请求重定向到指定URL地址。支持配置重定向后的协议、域名、端口、URL路径、查询参数，及重定向的方式。配置转发至动作的规则还客配置如下扩展动作：
   - 写入Header（响应）：负载均衡将重定向请求转发给客户端时，支持写入指定Header。

#### 转发流程

仅七层（HTTP/HTTPS）监听支持关联转发规则组，一个监听器只能关联一个转发规则组，同一个负载均衡下的多个监听器可以复用关联同一个转发规则组。监听器关联转发规则组后，应用负载均衡处理请求的流程如下：
![转发规则组列表页](../../../../image/Networking/ALB/ALB-urlmap1.png)

## 添加转发规则组
<div id="user-content-2"></div>

1. 通过应用负载均衡-详情-转发规则组进入转发规则组列表页。

	![转发规则组列表页](../../../../image/Networking/ALB/ALB-urlmap2.png)

2. 点击 **新建转发规则组**，打开转发规则组创建页，填写转发规则组名称和描述。

3. 点击**添加规则**，为转发规则组配置转发规则。
    - 域名：用于匹配客户端请求的域名。支持输入IPv4地址和域名，域名支持精确匹配和通配符匹配，输入限制如下：
      - 仅支持输入大小写字母、数字、英文中划线“-”和点“.”，不区分大小写，且不能超过110字符。
      - 最少包括一个点"."，不能以点"."和中划线"-"开头或结尾，中划线"-"前后不能为点"."。
      - 通配符匹配支持包括一个星"*"，输入格式为\*.XXX或XXX.\*。
    - URL路径：用于匹配客户端请求的URL路径，支持精确匹配和前缀匹配。
      - 必须以/开头。
      - 仅支持输入大小写字母、数字和特殊字符：$-_.+!'()%:@&=/，区分大小写，且不能超过128字符。
      - 前缀匹配支持包括一个星"*"，输入格式为/XXX\*或/\*。
    - 动作：匹配规则后执行的动作，取值包括转发至和重定向至。
      - 转发：将访问请求转发给指定后端服务，下拉列表中仅显示后端协议为HTTP的后端服务。转发至动作类型的规则支持配置如下扩展动作：
           - 写入Header（请求）：经过负载均衡转发给后端服务器的请求支持写入指定HTTP Header。将覆盖客户端请求Header中已有变量。
           - 删除Header（请求）：经过负载均衡转发给后端服务器的请求支持删除指定HTTP Header。
           - 镜像至（请求）：负载均衡将请求转发给后端服务器的同时，支持镜像一份到其他后端服务器组
           - 重写（请求）：支持重写访问请求的域名、路径和查询字段。重写路径字段支持以*结尾的后缀匹配。
           - 写入Header（响应）：负载均衡将后端服务器返回的请求转发给客户端时，支持写入指定Header。将覆盖响应Header中已有变量。
           - 删除Header（响应）：负载均衡将后端服务器返回的请求转发给客户端时，支持删除指定Header。
      - 重定向：将访问请求重定向到指定URL地址，可配置重定向的以下参数
            - 重定向后协议：取值为HTTP、HTTPS，缺省值为#{protocol}，缺省值表示重定向后不修改请求协议，与客户端请求协议一致
	    - 重定向后端口：取值为1~65535，缺省值为#{port}，缺省值表示重定向后不修改请求端口号，与客户端请求端口号保持一致
	    - 重定向后域名：支持输入IPv4地址和域名。域名输入限制为仅支持输入大小写字母、数字、英文中划线“-”和点“.”，最少包括一个点"."，不能以点"."和中划线"-"开头或结尾，中划线"-"前后不能为点"."，不区分大小写，且不能超过110字符。缺省值为#{domain},缺省值表示重定向后不修改请求域名，与客户端请求域名保持一致。
	    - 重定向后URL路径：必须以/开头，仅支持输入大小写字母、数字和特殊字符-_.+!'()%:@&=/，区分大小写，且不能超过128字符。缺省值为#{path}，缺省值表示重定向后不修改请求URL地址，与客户端请求URL路径保持一致。
	    - 重定向后查询参数：最长128个字符，支持除空格和#[]{}|<>$ ;外的可见字符。不需手动输入?，系统默认添加。缺省值为#{query}，缺省值表示重定向后不修改请求的查询参数，与客户端请求查询参数保持一致。
	    - 重定向方式：取值包括301、302、307、308。
	    - 重定向动作类型的规则支持配置如下扩展动作：
	      - 写入Header（响应）：负载均衡将重定向请求转发给客户端时，支持写入指定Header。

4. 点击转发规则列表栏中操作列的**编辑**，可编辑已添加的规则。

5. 点击转发规则列表栏中操作列的**删除**，可删除已添加的规则。

      **注意**：新添加的转发规则组绑定监听器后才会生效，具体请见[监听器配置指导](Listener-Management.md)。

## 管理转发规则组
<div id="user-content-3"></div>

1. 查看转发规则组：点击转发规则组名称进入转发规则组详情页，可查看转发规则组的详细信息。

1. 编辑转发规则组：点击转发规则组列表-操作栏下的**编辑**，可编辑转发规则组。

1. 删除转发规则组：点击转发规则组列表-操作栏下的**删除**，可删除转发规则组。删除成功后，与转发规则组绑定的后端服务将自动与其解除关联。		
